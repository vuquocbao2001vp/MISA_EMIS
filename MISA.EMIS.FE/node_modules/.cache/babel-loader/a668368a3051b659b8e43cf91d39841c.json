{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\nimport { __assign } from \"tslib\";\nimport RRule from './rrule';\nimport RRuleSet from './rruleset';\nimport dateutil from './dateutil';\nimport { includes, split } from './helpers';\nimport { parseString, parseDtstart } from './parsestring';\n/**\n * RRuleStr\n *  To parse a set of rrule strings\n */\n\nvar DEFAULT_OPTIONS = {\n  dtstart: null,\n  cache: false,\n  unfold: false,\n  forceset: false,\n  compatible: false,\n  tzid: null\n};\nexport function parseInput(s, options) {\n  var rrulevals = [];\n  var rdatevals = [];\n  var exrulevals = [];\n  var exdatevals = [];\n\n  var _a = parseDtstart(s),\n      dtstart = _a.dtstart,\n      tzid = _a.tzid;\n\n  var lines = splitIntoLines(s, options.unfold);\n  lines.forEach(function (line) {\n    if (!line) return;\n\n    var _a = breakDownLine(line),\n        name = _a.name,\n        parms = _a.parms,\n        value = _a.value;\n\n    switch (name.toUpperCase()) {\n      case 'RRULE':\n        if (parms.length) {\n          throw new Error(\"unsupported RRULE parm: \" + parms.join(','));\n        }\n\n        rrulevals.push(parseString(line));\n        break;\n\n      case 'RDATE':\n        var _b = /RDATE(?:;TZID=([^:=]+))?/i.exec(line),\n            _ = _b[0],\n            rdateTzid = _b[1];\n\n        if (rdateTzid && !tzid) {\n          tzid = rdateTzid;\n        }\n\n        rdatevals = rdatevals.concat(parseRDate(value, parms));\n        break;\n\n      case 'EXRULE':\n        if (parms.length) {\n          throw new Error(\"unsupported EXRULE parm: \" + parms.join(','));\n        }\n\n        exrulevals.push(parseString(value));\n        break;\n\n      case 'EXDATE':\n        exdatevals = exdatevals.concat(parseRDate(value, parms));\n        break;\n\n      case 'DTSTART':\n        break;\n\n      default:\n        throw new Error('unsupported property: ' + name);\n    }\n  });\n  return {\n    dtstart: dtstart,\n    tzid: tzid,\n    rrulevals: rrulevals,\n    rdatevals: rdatevals,\n    exrulevals: exrulevals,\n    exdatevals: exdatevals\n  };\n}\n\nfunction buildRule(s, options) {\n  var _a = parseInput(s, options),\n      rrulevals = _a.rrulevals,\n      rdatevals = _a.rdatevals,\n      exrulevals = _a.exrulevals,\n      exdatevals = _a.exdatevals,\n      dtstart = _a.dtstart,\n      tzid = _a.tzid;\n\n  var noCache = options.cache === false;\n\n  if (options.compatible) {\n    options.forceset = true;\n    options.unfold = true;\n  }\n\n  if (options.forceset || rrulevals.length > 1 || rdatevals.length || exrulevals.length || exdatevals.length) {\n    var rset_1 = new RRuleSet(noCache);\n    rset_1.dtstart(dtstart);\n    rset_1.tzid(tzid || undefined);\n    rrulevals.forEach(function (val) {\n      rset_1.rrule(new RRule(groomRruleOptions(val, dtstart, tzid), noCache));\n    });\n    rdatevals.forEach(function (date) {\n      rset_1.rdate(date);\n    });\n    exrulevals.forEach(function (val) {\n      rset_1.exrule(new RRule(groomRruleOptions(val, dtstart, tzid), noCache));\n    });\n    exdatevals.forEach(function (date) {\n      rset_1.exdate(date);\n    });\n    if (options.compatible && options.dtstart) rset_1.rdate(dtstart);\n    return rset_1;\n  }\n\n  var val = rrulevals[0] || {};\n  return new RRule(groomRruleOptions(val, val.dtstart || options.dtstart || dtstart, val.tzid || options.tzid || tzid), noCache);\n}\n\nexport function rrulestr(s, options) {\n  if (options === void 0) {\n    options = {};\n  }\n\n  return buildRule(s, initializeOptions(options));\n}\n\nfunction groomRruleOptions(val, dtstart, tzid) {\n  return __assign(__assign({}, val), {\n    dtstart: dtstart,\n    tzid: tzid\n  });\n}\n\nfunction initializeOptions(options) {\n  var invalid = [];\n  var keys = Object.keys(options);\n  var defaultKeys = Object.keys(DEFAULT_OPTIONS);\n  keys.forEach(function (key) {\n    if (!includes(defaultKeys, key)) invalid.push(key);\n  });\n\n  if (invalid.length) {\n    throw new Error('Invalid options: ' + invalid.join(', '));\n  }\n\n  return __assign(__assign({}, DEFAULT_OPTIONS), options);\n}\n\nfunction extractName(line) {\n  if (line.indexOf(':') === -1) {\n    return {\n      name: 'RRULE',\n      value: line\n    };\n  }\n\n  var _a = split(line, ':', 1),\n      name = _a[0],\n      value = _a[1];\n\n  return {\n    name: name,\n    value: value\n  };\n}\n\nfunction breakDownLine(line) {\n  var _a = extractName(line),\n      name = _a.name,\n      value = _a.value;\n\n  var parms = name.split(';');\n  if (!parms) throw new Error('empty property name');\n  return {\n    name: parms[0].toUpperCase(),\n    parms: parms.slice(1),\n    value: value\n  };\n}\n\nfunction splitIntoLines(s, unfold) {\n  if (unfold === void 0) {\n    unfold = false;\n  }\n\n  s = s && s.trim();\n  if (!s) throw new Error('Invalid empty string'); // More info about 'unfold' option\n  // Go head to http://www.ietf.org/rfc/rfc2445.txt\n\n  if (!unfold) {\n    return s.split(/\\s/);\n  }\n\n  var lines = s.split('\\n');\n  var i = 0;\n\n  while (i < lines.length) {\n    // TODO\n    var line = lines[i] = lines[i].replace(/\\s+$/g, '');\n\n    if (!line) {\n      lines.splice(i, 1);\n    } else if (i > 0 && line[0] === ' ') {\n      lines[i - 1] += line.slice(1);\n      lines.splice(i, 1);\n    } else {\n      i += 1;\n    }\n  }\n\n  return lines;\n}\n\nfunction validateDateParm(parms) {\n  parms.forEach(function (parm) {\n    if (!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(parm)) {\n      throw new Error('unsupported RDATE/EXDATE parm: ' + parm);\n    }\n  });\n}\n\nfunction parseRDate(rdateval, parms) {\n  validateDateParm(parms);\n  return rdateval.split(',').map(function (datestr) {\n    return dateutil.untilStringToDate(datestr);\n  });\n}","map":{"version":3,"mappings":"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","names":["RRule","RRuleSet","dateutil","includes","split","parseString","parseDtstart","DEFAULT_OPTIONS","dtstart","cache","unfold","forceset","compatible","tzid","parseInput","s","options","rrulevals","rdatevals","exrulevals","exdatevals","lines","splitIntoLines","forEach","line","name","parms","value","toUpperCase","length","Error","join","push","_","rdateTzid","concat","parseRDate","buildRule","noCache","rset_1","undefined","rrule","groomRruleOptions","val","rdate","date","exrule","exdate","rrulestr","initializeOptions","invalid","keys","Object","defaultKeys","key","extractName","indexOf","breakDownLine","slice","trim","i","replace","splice","validateDateParm","test","parm","rdateval","map","untilStringToDate","datestr"],"sourceRoot":"","sources":["../../../src/rrulestr.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}